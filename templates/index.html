<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IL-9 Democratic Primary 2026 Forecast</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>IL-9 Democratic Primary 2026</h1>
            <p class="subtitle">Forecast Model</p>
            <div class="last-updated">
                <span id="updated-time">Loading...</span>
            </div>
        </header>

        <main>
            <!-- Odds Display -->
            <section class="forecast-section">
                <h2>Current Odds</h2>
                <div class="candidates-grid" id="candidates-container">
                    <!-- Populated by JavaScript -->
                </div>
            </section>

            <!-- Timeline Chart -->
            <section class="forecast-section">
                <h2>Polling Trend (90 Days)</h2>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </section>

            <!-- Summary Stats -->
            <section class="forecast-section">
                <h2>Summary</h2>
                <div class="summary-stats">
                    <div class="stat">
                        <h3>Primary Date</h3>
                        <p id="primary-date">Loading...</p>
                    </div>
                    <div class="stat">
                        <h3>Candidates</h3>
                        <p>6</p>
                    </div>
                    <div class="stat">
                        <h3>District</h3>
                        <p>Illinois-9</p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>IL9Cast â€” Created by Ryan McComb</p>
        </footer>
    </div>

    <script>
        let timelineChart;

        async function loadForecast() {
            try {
                const response = await fetch('/api/forecast');
                const data = await response.json();

                // Update last updated time
                const updated = new Date(data.last_updated);
                document.getElementById('updated-time').textContent = `Last updated: ${updated.toLocaleString()}`;
                document.getElementById('primary-date').textContent = data.primary_date;

                // Render candidates
                renderCandidates(data.candidates);

                // Load timeline data
                await loadTimeline();
            } catch (error) {
                console.error('Error loading forecast:', error);
            }
        }

        function renderCandidates(candidates) {
            const container = document.getElementById('candidates-container');
            container.innerHTML = '';

            // Sort by probability descending
            candidates.sort((a, b) => b.probability - a.probability);

            candidates.forEach((candidate, index) => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                card.style.borderLeftColor = candidate.color;

                const trendEmoji = {
                    'up': 'ðŸ“ˆ',
                    'down': 'ðŸ“‰',
                    'stable': 'â†’'
                }[candidate.trend] || 'â†’';

                const rankBadge = index + 1 <= 3 ? `<span class="rank-badge">#${index + 1}</span>` : '';

                card.innerHTML = `
                    ${rankBadge}
                    <div class="candidate-header">
                        <h3>${candidate.name}</h3>
                        <span class="trend ${candidate.trend}">${trendEmoji}</span>
                    </div>
                    <p class="role">${candidate.party_role}</p>
                    <div class="probability-display">
                        <div class="prob-number">${candidate.probability}%</div>
                        <div class="prob-bar">
                            <div class="prob-fill" style="width: ${candidate.probability}%; background-color: ${candidate.color};"></div>
                        </div>
                    </div>
                    <div class="polling-avg">Polling Avg: ${candidate.polling_avg}%</div>
                `;

                container.appendChild(card);
            });
        }

        async function loadTimeline() {
            try {
                const response = await fetch('/api/timeline');
                const timeline = await response.json();

                // Prepare chart data
                const labels = timeline.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const datasets = [];

                // Get candidate names from first entry
                const candidateNames = Object.keys(timeline[0].candidates);
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'];

                candidateNames.forEach((name, idx) => {
                    const data = timeline.map(d => d.candidates[name]);
                    datasets.push({
                        label: name,
                        data: data,
                        borderColor: colors[idx],
                        backgroundColor: colors[idx] + '20',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 3,
                        pointBackgroundColor: colors[idx]
                    });
                });

                // Create or update chart
                const ctx = document.getElementById('timelineChart').getContext('2d');
                if (timelineChart) {
                    timelineChart.destroy();
                }
                timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 35,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadForecast);

        // Refresh every 5 minutes
        setInterval(loadForecast, 5 * 60 * 1000);
    </script>
</body>
</html>
